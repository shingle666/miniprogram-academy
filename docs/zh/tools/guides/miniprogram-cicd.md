# å°ç¨‹åº CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²æŒ‡å—

æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰æ˜¯ç°ä»£è½¯ä»¶å¼€å‘çš„é‡è¦å®è·µï¼Œå¯ä»¥å¸®åŠ©å°ç¨‹åºå¼€å‘å›¢é˜Ÿæé«˜å¼€å‘æ•ˆç‡ã€ä¿è¯ä»£ç è´¨é‡ã€å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä¸ºå°ç¨‹åºé¡¹ç›®æ­å»ºå®Œæ•´çš„ CI/CD æµç¨‹ã€‚

## CI/CD æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ CI/CD

- **æŒç»­é›†æˆï¼ˆCIï¼‰**ï¼šå¼€å‘äººå‘˜é¢‘ç¹åœ°å°†ä»£ç é›†æˆåˆ°ä¸»åˆ†æ”¯ï¼Œæ¯æ¬¡é›†æˆéƒ½é€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºæ¥éªŒè¯
- **æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰**ï¼šåœ¨æŒç»­é›†æˆçš„åŸºç¡€ä¸Šï¼Œè‡ªåŠ¨å°†é€šè¿‡æµ‹è¯•çš„ä»£ç éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### å°ç¨‹åº CI/CD çš„ä»·å€¼

- **æé«˜å¼€å‘æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²æµç¨‹
- **ä¿è¯ä»£ç è´¨é‡**ï¼šè‡ªåŠ¨åŒ–ä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•
- **å‡å°‘äººä¸ºé”™è¯¯**ï¼šæ ‡å‡†åŒ–çš„éƒ¨ç½²æµç¨‹
- **å¿«é€Ÿåé¦ˆ**ï¼šåŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜
- **ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨åŒ–ç‰ˆæœ¬å‘å¸ƒå’Œå›æ»š

## æŠ€æœ¯æ ˆé€‰æ‹©

### ä»£ç æ‰˜ç®¡å¹³å°
- **GitHub**ï¼šæœ€æµè¡Œçš„ä»£ç æ‰˜ç®¡å¹³å°
- **GitLab**ï¼šæä¾›å®Œæ•´çš„ DevOps è§£å†³æ–¹æ¡ˆ
- **ç äº‘ï¼ˆGiteeï¼‰**ï¼šå›½å†…ä¸»æµçš„ä»£ç æ‰˜ç®¡å¹³å°
- **è…¾è®¯å·¥èœ‚**ï¼šè…¾è®¯å†…éƒ¨ä»£ç æ‰˜ç®¡å¹³å°

### CI/CD å¹³å°
- **GitHub Actions**ï¼šGitHub åŸç”Ÿ CI/CD æœåŠ¡
- **GitLab CI/CD**ï¼šGitLab é›†æˆçš„ CI/CD æœåŠ¡
- **Jenkins**ï¼šå¼€æºçš„è‡ªåŠ¨åŒ–æœåŠ¡å™¨
- **è…¾è®¯äº‘ CODING**ï¼šè…¾è®¯äº‘æä¾›çš„ DevOps å¹³å°

### æ„å»ºå·¥å…·
- **å¾®ä¿¡å¼€å‘è€…å·¥å…· CLI**ï¼šå®˜æ–¹å‘½ä»¤è¡Œå·¥å…·
- **miniprogram-ci**ï¼šå¾®ä¿¡å°ç¨‹åº CI å·¥å…·
- **Webpack**ï¼šæ¨¡å—æ‰“åŒ…å·¥å…·
- **Gulp**ï¼šä»»åŠ¡è¿è¡Œå™¨

## ç¯å¢ƒå‡†å¤‡

### å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…· CLI

```bash
# å…¨å±€å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·å‘½ä»¤è¡Œ
npm install -g miniprogram-ci

# æˆ–è€…åœ¨é¡¹ç›®ä¸­å®‰è£…
npm install --save-dev miniprogram-ci
```

### è·å–å°ç¨‹åºå¯†é’¥

1. **ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°**
   - è¿›å…¥å°ç¨‹åºç®¡ç†åå°
   - ç‚¹å‡»"å¼€å‘" -> "å¼€å‘ç®¡ç†" -> "å¼€å‘è®¾ç½®"

2. **ç”Ÿæˆä¸Šä¼ å¯†é’¥**
   - åœ¨"å°ç¨‹åºä»£ç ä¸Šä¼ "éƒ¨åˆ†ç‚¹å‡»"ç”Ÿæˆ"
   - ä¸‹è½½å¯†é’¥æ–‡ä»¶ï¼ˆprivate.keyï¼‰
   - è®°å½•å¯†é’¥ ID

3. **é…ç½® IP ç™½åå•**
   - åœ¨"å°ç¨‹åºä»£ç ä¸Šä¼ "éƒ¨åˆ†é…ç½® IP ç™½åå•
   - æ·»åŠ  CI/CD æœåŠ¡å™¨çš„ IP åœ°å€

### é¡¹ç›®é…ç½®

```javascript
// project.config.json
{
  "appid": "your-app-id",
  "projectname": "your-project-name",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": false,
    "coverView": true,
    "nodeModules": false,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    },
    "enableEngineNative": false,
    "bundle": false,
    "useIsolateContext": true,
    "useCompilerModule": true,
    "userConfirmedUseCompilerModuleSwitch": false,
    "userConfirmedBundleSwitch": false,
    "packNpmManually": false,
    "packNpmRelationList": [],
    "minifyWXSS": true
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "srcMiniprogramRoot": "dist/",
  "packOptions": {
    "ignore": [
      {
        "type": "file",
        "value": ".eslintrc.js"
      },
      {
        "type": "file",
        "value": ".gitignore"
      },
      {
        "type": "file",
        "value": "README.md"
      }
    ]
  },
  "condition": {}
}
```

## GitHub Actions å®ç°

### åŸºç¡€å·¥ä½œæµé…ç½®

```yaml
# .github/workflows/ci.yml
name: å°ç¨‹åº CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '16'

jobs:
  lint-and-test:
    name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: npm run lint
      
    - name: ç±»å‹æ£€æŸ¥
      run: npm run type-check
      
    - name: å•å…ƒæµ‹è¯•
      run: npm run test
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist/
        retention-days: 1

  deploy-preview:
    name: éƒ¨ç½²é¢„è§ˆç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: dist
        path: dist/
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: å®‰è£… miniprogram-ci
      run: npm install -g miniprogram-ci
      
    - name: åˆ›å»ºå¯†é’¥æ–‡ä»¶
      run: echo "${{ secrets.MINIPROGRAM_PRIVATE_KEY }}" > private.key
      
    - name: ä¸Šä¼ é¢„è§ˆç‰ˆæœ¬
      run: |
        node scripts/upload-preview.js
      env:
        APPID: ${{ secrets.MINIPROGRAM_APPID }}
        PRIVATE_KEY_PATH: ./private.key
        
    - name: æ¸…ç†å¯†é’¥æ–‡ä»¶
      run: rm -f private.key

  deploy-production:
    name: éƒ¨ç½²ç”Ÿäº§ç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: dist
        path: dist/
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: å®‰è£… miniprogram-ci
      run: npm install -g miniprogram-ci
      
    - name: åˆ›å»ºå¯†é’¥æ–‡ä»¶
      run: echo "${{ secrets.MINIPROGRAM_PRIVATE_KEY }}" > private.key
      
    - name: ä¸Šä¼ ç”Ÿäº§ç‰ˆæœ¬
      run: |
        node scripts/upload-production.js
      env:
        APPID: ${{ secrets.MINIPROGRAM_APPID }}
        PRIVATE_KEY_PATH: ./private.key
        
    - name: æ¸…ç†å¯†é’¥æ–‡ä»¶
      run: rm -f private.key
      
    - name: åˆ›å»º GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ v${{ github.run_number }}
          
          æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
          æäº¤è€…: ${{ github.event.head_commit.author.name }}
        draft: false
        prerelease: false
```

### ä¸Šä¼ è„šæœ¬

#### é¢„è§ˆç‰ˆæœ¬ä¸Šä¼ è„šæœ¬

```javascript
// scripts/upload-preview.js
const ci = require('miniprogram-ci')
const path = require('path')
const fs = require('fs')

async function uploadPreview() {
  try {
    // è¯»å–é¡¹ç›®é…ç½®
    const projectConfig = JSON.parse(
      fs.readFileSync('./project.config.json', 'utf8')
    )
    
    // åˆ›å»ºé¡¹ç›®å®ä¾‹
    const project = new ci.Project({
      appid: process.env.APPID,
      type: 'miniProgram',
      projectPath: path.resolve('./'),
      privateKeyPath: path.resolve(process.env.PRIVATE_KEY_PATH),
      ignores: ['node_modules/**/*']
    })
    
    // è·å–ç‰ˆæœ¬ä¿¡æ¯
    const version = `preview-${Date.now()}`
    const desc = `é¢„è§ˆç‰ˆæœ¬ - ${new Date().toLocaleString()}`
    
    console.log('å¼€å§‹ä¸Šä¼ é¢„è§ˆç‰ˆæœ¬...')
    console.log(`ç‰ˆæœ¬: ${version}`)
    console.log(`æè¿°: ${desc}`)
    
    // ä¸Šä¼ é¢„è§ˆç‰ˆæœ¬
    const previewResult = await ci.preview({
      project,
      desc: desc,
      setting: {
        es6: true,
        es7: true,
        minify: true,
        codeProtect: false,
        minifyJS: true,
        minifyWXML: true,
        minifyWXSS: true,
        autoPrefixWXSS: true
      },
      qrcodeFormat: 'image',
      qrcodeOutputDest: path.resolve('./preview-qrcode.jpg'),
      onProgressUpdate: (info) => {
        console.log('ä¸Šä¼ è¿›åº¦:', info)
      }
    })
    
    console.log('é¢„è§ˆç‰ˆæœ¬ä¸Šä¼ æˆåŠŸ!')
    console.log('é¢„è§ˆäºŒç»´ç å·²ä¿å­˜åˆ°: preview-qrcode.jpg')
    
    return previewResult
  } catch (error) {
    console.error('ä¸Šä¼ é¢„è§ˆç‰ˆæœ¬å¤±è´¥:', error)
    process.exit(1)
  }
}

uploadPreview()
```

#### ç”Ÿäº§ç‰ˆæœ¬ä¸Šä¼ è„šæœ¬

```javascript
// scripts/upload-production.js
const ci = require('miniprogram-ci')
const path = require('path')
const fs = require('fs')

async function uploadProduction() {
  try {
    // è¯»å– package.json è·å–ç‰ˆæœ¬å·
    const packageJson = JSON.parse(
      fs.readFileSync('./package.json', 'utf8')
    )
    
    // åˆ›å»ºé¡¹ç›®å®ä¾‹
    const project = new ci.Project({
      appid: process.env.APPID,
      type: 'miniProgram',
      projectPath: path.resolve('./'),
      privateKeyPath: path.resolve(process.env.PRIVATE_KEY_PATH),
      ignores: ['node_modules/**/*']
    })
    
    // ç‰ˆæœ¬ä¿¡æ¯
    const version = packageJson.version
    const desc = `ç”Ÿäº§ç‰ˆæœ¬ v${version} - ${new Date().toLocaleString()}`
    
    console.log('å¼€å§‹ä¸Šä¼ ç”Ÿäº§ç‰ˆæœ¬...')
    console.log(`ç‰ˆæœ¬: ${version}`)
    console.log(`æè¿°: ${desc}`)
    
    // ä¸Šä¼ ä»£ç 
    const uploadResult = await ci.upload({
      project,
      version: version,
      desc: desc,
      setting: {
        es6: true,
        es7: true,
        minify: true,
        codeProtect: true,
        minifyJS: true,
        minifyWXML: true,
        minifyWXSS: true,
        autoPrefixWXSS: true
      },
      onProgressUpdate: (info) => {
        console.log('ä¸Šä¼ è¿›åº¦:', info)
      }
    })
    
    console.log('ç”Ÿäº§ç‰ˆæœ¬ä¸Šä¼ æˆåŠŸ!')
    console.log('ä¸Šä¼ ç»“æœ:', uploadResult)
    
    // å¯é€‰ï¼šè‡ªåŠ¨æäº¤å®¡æ ¸
    if (process.env.AUTO_SUBMIT === 'true') {
      console.log('å¼€å§‹æäº¤å®¡æ ¸...')
      
      const submitResult = await ci.submitAudit({
        project,
        version: version,
        desc: desc,
        auditInfo: {
          first_class: 'å·¥å…·',
          second_class: 'æ•ˆç‡',
          first_item: '00',
          second_item: '00',
          title: packageJson.name
        }
      })
      
      console.log('æäº¤å®¡æ ¸æˆåŠŸ!', submitResult)
    }
    
    return uploadResult
  } catch (error) {
    console.error('ä¸Šä¼ ç”Ÿäº§ç‰ˆæœ¬å¤±è´¥:', error)
    process.exit(1)
  }
}

uploadProduction()
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ GitHub ä»“åº“çš„ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```
MINIPROGRAM_APPID: å°ç¨‹åº AppID
MINIPROGRAM_PRIVATE_KEY: ä¸Šä¼ å¯†é’¥å†…å®¹ï¼ˆprivate.key æ–‡ä»¶çš„å®Œæ•´å†…å®¹ï¼‰
```

## GitLab CI/CD å®ç°

### GitLab CI é…ç½®

```yaml
# .gitlab-ci.yml
stages:
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "16"
  DOCKER_DRIVER: overlay2

# ç¼“å­˜é…ç½®
cache:
  paths:
    - node_modules/
    - .npm/

before_script:
  - apt-get update -qq && apt-get install -y -qq git curl
  - curl -sL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
  - apt-get install -y nodejs
  - npm ci --cache .npm --prefer-offline

# ä»£ç æ£€æŸ¥
lint:
  stage: lint
  script:
    - npm run lint
    - npm run type-check
  only:
    - merge_requests
    - main
    - develop

# å•å…ƒæµ‹è¯•
test:
  stage: test
  script:
    - npm run test
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  only:
    - merge_requests
    - main
    - develop

# æ„å»º
build:
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# éƒ¨ç½²é¢„è§ˆç‰ˆæœ¬
deploy:preview:
  stage: deploy
  dependencies:
    - build
  script:
    - npm install -g miniprogram-ci
    - echo "$MINIPROGRAM_PRIVATE_KEY" > private.key
    - node scripts/upload-preview.js
    - rm -f private.key
  environment:
    name: preview
  only:
    - merge_requests

# éƒ¨ç½²ç”Ÿäº§ç‰ˆæœ¬
deploy:production:
  stage: deploy
  dependencies:
    - build
  script:
    - npm install -g miniprogram-ci
    - echo "$MINIPROGRAM_PRIVATE_KEY" > private.key
    - node scripts/upload-production.js
    - rm -f private.key
  environment:
    name: production
  only:
    - main
  when: manual
```

## Jenkins å®ç°

### Jenkinsfile é…ç½®

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        NODE_VERSION = '16'
        MINIPROGRAM_APPID = credentials('miniprogram-appid')
        MINIPROGRAM_PRIVATE_KEY = credentials('miniprogram-private-key')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                script {
                    // å®‰è£… Node.js
                    sh '''
                        curl -sL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                    '''
                    
                    // å®‰è£…ä¾èµ–
                    sh 'npm ci'
                }
            }
        }
        
        stage('Lint') {
            steps {
                sh 'npm run lint'
                sh 'npm run type-check'
            }
        }
        
        stage('Test') {
            steps {
                sh 'npm run test'
            }
            post {
                always {
                    publishTestResults testResultsPattern: 'test-results.xml'
                    publishCoverage adapters: [
                        coberturaAdapter('coverage/cobertura-coverage.xml')
                    ]
                }
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm run build'
            }
            post {
                success {
                    archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
                }
            }
        }
        
        stage('Deploy Preview') {
            when {
                changeRequest()
            }
            steps {
                script {
                    sh '''
                        npm install -g miniprogram-ci
                        echo "$MINIPROGRAM_PRIVATE_KEY" > private.key
                        node scripts/upload-preview.js
                        rm -f private.key
                    '''
                }
            }
        }
        
        stage('Deploy Production') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh '''
                        npm install -g miniprogram-ci
                        echo "$MINIPROGRAM_PRIVATE_KEY" > private.key
                        node scripts/upload-production.js
                        rm -f private.key
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            emailext (
                subject: "æ„å»ºæˆåŠŸ: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "æ„å»ºæˆåŠŸï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹: ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
        failure {
            emailext (
                subject: "æ„å»ºå¤±è´¥: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "æ„å»ºå¤±è´¥ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹: ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

## é«˜çº§åŠŸèƒ½

### å¤šç¯å¢ƒéƒ¨ç½²

```javascript
// scripts/deploy.js
const ci = require('miniprogram-ci')
const path = require('path')
const fs = require('fs')

// ç¯å¢ƒé…ç½®
const environments = {
  dev: {
    appid: process.env.DEV_APPID,
    privateKeyPath: './keys/dev-private.key',
    desc: 'å¼€å‘ç¯å¢ƒ'
  },
  test: {
    appid: process.env.TEST_APPID,
    privateKeyPath: './keys/test-private.key',
    desc: 'æµ‹è¯•ç¯å¢ƒ'
  },
  prod: {
    appid: process.env.PROD_APPID,
    privateKeyPath: './keys/prod-private.key',
    desc: 'ç”Ÿäº§ç¯å¢ƒ'
  }
}

async function deploy(env) {
  const config = environments[env]
  if (!config) {
    throw new Error(`æœªçŸ¥ç¯å¢ƒ: ${env}`)
  }
  
  console.log(`å¼€å§‹éƒ¨ç½²åˆ° ${config.desc}...`)
  
  const project = new ci.Project({
    appid: config.appid,
    type: 'miniProgram',
    projectPath: path.resolve('./'),
    privateKeyPath: path.resolve(config.privateKeyPath),
    ignores: ['node_modules/**/*']
  })
  
  const packageJson = JSON.parse(
    fs.readFileSync('./package.json', 'utf8')
  )
  
  const version = `${packageJson.version}-${env}`
  const desc = `${config.desc} v${version} - ${new Date().toLocaleString()}`
  
  const result = await ci.upload({
    project,
    version: version,
    desc: desc,
    setting: {
      es6: true,
      es7: true,
      minify: env === 'prod',
      codeProtect: env === 'prod',
      minifyJS: true,
      minifyWXML: true,
      minifyWXSS: true,
      autoPrefixWXSS: true
    },
    onProgressUpdate: (info) => {
      console.log(`${config.desc} ä¸Šä¼ è¿›åº¦:`, info)
    }
  })
  
  console.log(`${config.desc} éƒ¨ç½²æˆåŠŸ!`)
  return result
}

// ä»å‘½ä»¤è¡Œå‚æ•°è·å–ç¯å¢ƒ
const env = process.argv[2] || 'dev'
deploy(env).catch(console.error)
```

### è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ

```javascript
// scripts/e2e-test.js
const puppeteer = require('puppeteer')
const ci = require('miniprogram-ci')

async function runE2ETests() {
  console.log('å¼€å§‹ç«¯åˆ°ç«¯æµ‹è¯•...')
  
  // 1. ä¸Šä¼ æµ‹è¯•ç‰ˆæœ¬
  const project = new ci.Project({
    appid: process.env.TEST_APPID,
    type: 'miniProgram',
    projectPath: path.resolve('./'),
    privateKeyPath: path.resolve('./test-private.key'),
    ignores: ['node_modules/**/*']
  })
  
  const previewResult = await ci.preview({
    project,
    desc: 'E2E æµ‹è¯•ç‰ˆæœ¬',
    setting: {
      es6: true,
      minify: false
    },
    qrcodeFormat: 'base64'
  })
  
  // 2. å¯åŠ¨æµè§ˆå™¨è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
  const browser = await puppeteer.launch({
    headless: false,
    devtools: true
  })
  
  const page = await browser.newPage()
  
  try {
    // æ¨¡æ‹Ÿå°ç¨‹åºæµ‹è¯•åœºæ™¯
    await page.goto('https://developers.weixin.qq.com/s/simulator')
    
    // æ‰«æé¢„è§ˆäºŒç»´ç 
    await page.evaluate((qrcode) => {
      // æ³¨å…¥äºŒç»´ç åˆ°æ¨¡æ‹Ÿå™¨
      document.querySelector('#qrcode-input').value = qrcode
    }, previewResult.qrCodeBuffer.toString('base64'))
    
    // ç­‰å¾…å°ç¨‹åºåŠ è½½
    await page.waitForTimeout(5000)
    
    // æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
    await runTestCases(page)
    
    console.log('E2E æµ‹è¯•é€šè¿‡!')
  } catch (error) {
    console.error('E2E æµ‹è¯•å¤±è´¥:', error)
    throw error
  } finally {
    await browser.close()
  }
}

async function runTestCases(page) {
  // æµ‹è¯•ç”¨ä¾‹ 1: é¦–é¡µåŠ è½½
  await page.waitForSelector('.home-page')
  console.log('âœ“ é¦–é¡µåŠ è½½æˆåŠŸ')
  
  // æµ‹è¯•ç”¨ä¾‹ 2: å¯¼èˆªåŠŸèƒ½
  await page.click('.nav-item[data-page="profile"]')
  await page.waitForSelector('.profile-page')
  console.log('âœ“ é¡µé¢å¯¼èˆªæˆåŠŸ')
  
  // æµ‹è¯•ç”¨ä¾‹ 3: è¡¨å•æäº¤
  await page.type('.form-input[name="username"]', 'testuser')
  await page.click('.submit-button')
  await page.waitForSelector('.success-message')
  console.log('âœ“ è¡¨å•æäº¤æˆåŠŸ')
}

if (require.main === module) {
  runE2ETests().catch(console.error)
}
```

### ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š

```javascript
// scripts/version-manager.js
const ci = require('miniprogram-ci')
const fs = require('fs')
const path = require('path')

class VersionManager {
  constructor(appid, privateKeyPath) {
    this.project = new ci.Project({
      appid,
      type: 'miniProgram',
      projectPath: path.resolve('./'),
      privateKeyPath: path.resolve(privateKeyPath),
      ignores: ['node_modules/**/*']
    })
    
    this.versionsFile = './versions.json'
  }
  
  // è·å–ç‰ˆæœ¬å†å²
  getVersionHistory() {
    if (fs.existsSync(this.versionsFile)) {
      return JSON.parse(fs.readFileSync(this.versionsFile, 'utf8'))
    }
    return []
  }
  
  // ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
  saveVersion(version, desc, commitHash) {
    const versions = this.getVersionHistory()
    versions.unshift({
      version,
      desc,
      commitHash,
      timestamp: new Date().toISOString(),
      status: 'uploaded'
    })
    
    // åªä¿ç•™æœ€è¿‘ 50 ä¸ªç‰ˆæœ¬
    if (versions.length > 50) {
      versions.splice(50)
    }
    
    fs.writeFileSync(this.versionsFile, JSON.stringify(versions, null, 2))
  }
  
  // éƒ¨ç½²æ–°ç‰ˆæœ¬
  async deploy(version, desc, commitHash) {
    console.log(`éƒ¨ç½²ç‰ˆæœ¬ ${version}...`)
    
    const result = await ci.upload({
      project: this.project,
      version,
      desc,
      setting: {
        es6: true,
        es7: true,
        minify: true,
        codeProtect: true
      },
      onProgressUpdate: (info) => {
        console.log('ä¸Šä¼ è¿›åº¦:', info)
      }
    })
    
    this.saveVersion(version, desc, commitHash)
    console.log(`ç‰ˆæœ¬ ${version} éƒ¨ç½²æˆåŠŸ!`)
    
    return result
  }
  
  // å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
  async rollback(targetVersion) {
    const versions = this.getVersionHistory()
    const targetVersionInfo = versions.find(v => v.version === targetVersion)
    
    if (!targetVersionInfo) {
      throw new Error(`ç‰ˆæœ¬ ${targetVersion} ä¸å­˜åœ¨`)
    }
    
    console.log(`å›æ»šåˆ°ç‰ˆæœ¬ ${targetVersion}...`)
    
    // æ£€å‡ºæŒ‡å®šç‰ˆæœ¬çš„ä»£ç 
    const { execSync } = require('child_process')
    execSync(`git checkout ${targetVersionInfo.commitHash}`)
    
    try {
      // é‡æ–°æ„å»º
      execSync('npm run build')
      
      // éƒ¨ç½²
      const rollbackVersion = `${targetVersion}-rollback-${Date.now()}`
      const result = await ci.upload({
        project: this.project,
        version: rollbackVersion,
        desc: `å›æ»šåˆ°ç‰ˆæœ¬ ${targetVersion}`,
        setting: {
          es6: true,
          es7: true,
          minify: true,
          codeProtect: true
        }
      })
      
      console.log(`å›æ»šåˆ°ç‰ˆæœ¬ ${targetVersion} æˆåŠŸ!`)
      return result
    } finally {
      // å›åˆ°æœ€æ–°ä»£ç 
      execSync('git checkout main')
    }
  }
  
  // åˆ—å‡ºç‰ˆæœ¬å†å²
  listVersions() {
    const versions = this.getVersionHistory()
    console.log('ç‰ˆæœ¬å†å²:')
    versions.forEach((version, index) => {
      console.log(`${index + 1}. ${version.version} - ${version.desc}`)
      console.log(`   æ—¶é—´: ${version.timestamp}`)
      console.log(`   æäº¤: ${version.commitHash}`)
      console.log(`   çŠ¶æ€: ${version.status}`)
      console.log('')
    })
  }
}

// å‘½ä»¤è¡Œæ¥å£
if (require.main === module) {
  const [,, command, ...args] = process.argv
  
  const manager = new VersionManager(
    process.env.MINIPROGRAM_APPID,
    process.env.PRIVATE_KEY_PATH
  )
  
  switch (command) {
    case 'deploy':
      const [version, desc, commitHash] = args
      manager.deploy(version, desc, commitHash).catch(console.error)
      break
      
    case 'rollback':
      const [targetVersion] = args
      manager.rollback(targetVersion).catch(console.error)
      break
      
    case 'list':
      manager.listVersions()
      break
      
    default:
      console.log('ç”¨æ³•:')
      console.log('  node version-manager.js deploy <version> <desc> <commit>')
      console.log('  node version-manager.js rollback <version>')
      console.log('  node version-manager.js list')
  }
}
```

## ç›‘æ§å’Œé€šçŸ¥

### éƒ¨ç½²çŠ¶æ€é€šçŸ¥

```javascript
// scripts/notification.js
const axios = require('axios')

class NotificationService {
  constructor() {
    this.webhooks = {
      slack: process.env.SLACK_WEBHOOK_URL,
      dingtalk: process.env.DINGTALK_WEBHOOK_URL,
      wechat: process.env.WECHAT_WEBHOOK_URL
    }
  }
  
  // å‘é€ Slack é€šçŸ¥
  async sendSlackNotification(message, color = 'good') {
    if (!this.webhooks.slack) return
    
    try {
      await axios.post(this.webhooks.slack, {
        attachments: [{
          color: color,
          text: message,
          ts: Math.floor(Date.now() / 1000)
        }]
      })
      console.log('Slack é€šçŸ¥å‘é€æˆåŠŸ')
    } catch (error) {
      console.error('Slack é€šçŸ¥å‘é€å¤±è´¥:', error.message)
    }
  }
  
  // å‘é€é’‰é’‰é€šçŸ¥
  async sendDingTalkNotification(message) {
    if (!this.webhooks.dingtalk) return
    
    try {
      await axios.post(this.webhooks.dingtalk, {
        msgtype: 'text',
        text: {
          content: message
        }
      })
      console.log('é’‰é’‰é€šçŸ¥å‘é€æˆåŠŸ')
    } catch (error) {
      console.error('é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥:', error.message)
    }
  }
  
  // å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
  async sendWeChatNotification(message) {
    if (!this.webhooks.wechat) return
    
    try {
      await axios.post(this.webhooks.wechat, {
        msgtype: 'text',
        text: {
          content: message
        }
      })
      console.log('ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ')
    } catch (error) {
      console.error('ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥:', error.message)
    }
  }
  
  // å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
  async notifyDeploySuccess(version, environment, commitHash) {
    const message = `ğŸ‰ å°ç¨‹åºéƒ¨ç½²æˆåŠŸï¼
ç‰ˆæœ¬: ${version}
ç¯å¢ƒ: ${environment}
æäº¤: ${commitHash}
æ—¶é—´: ${new Date().toLocaleString()}`
    
    await Promise.all([
      this.sendSlackNotification(message, 'good'),
      this.sendDingTalkNotification(message),
      this.sendWeChatNotification(message)
    ])
  }
  
  // å‘é€éƒ¨ç½²å¤±è´¥é€šçŸ¥
  async notifyDeployFailure(version, environment, error) {
    const message = `âŒ å°ç¨‹åºéƒ¨ç½²å¤±è´¥ï¼
ç‰ˆæœ¬: ${version}
ç¯å¢ƒ: ${environment}
é”™è¯¯: ${error}
æ—¶é—´: ${new Date().toLocaleString()}`
    
    await Promise.all([
      this.sendSlackNotification(message, 'danger'),
      this.sendDingTalkNotification(message),
      this.sendWeChatNotification(message)
    ])
  }
}

module.exports = NotificationService
```

### é›†æˆé€šçŸ¥åˆ°éƒ¨ç½²è„šæœ¬

```javascript
// scripts/deploy-with-notification.js
const ci = require('miniprogram-ci')
const NotificationService = require('./notification')

async function deployWithNotification() {
  const notification = new NotificationService()
  const version = process.env.VERSION || '1.0.0'
  const environment = process.env.ENVIRONMENT || 'production'
  const commitHash = process.env.COMMIT_HASH || 'unknown'
  
  try {
    console.log(`å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬ ${version} åˆ° ${environment}...`)
    
    // åˆ›å»ºé¡¹ç›®å®ä¾‹
    const project = new ci.Project({
      appid: process.env.MINIPROGRAM_APPID,
      type: 'miniProgram',
      projectPath: path.resolve('./'),
      privateKeyPath: path.resolve(process.env.PRIVATE_KEY_PATH),
      ignores: ['node_modules/**/*']
    })
    
    // ä¸Šä¼ ä»£ç 
    const result = await ci.upload({
      project,
      version: version,
      desc: `${environment} ç¯å¢ƒéƒ¨ç½² v${version}`,
      setting: {
        es6: true,
        es7: true,
        minify: environment === 'production',
        codeProtect: environment === 'production'
      },
      onProgressUpdate: (info) => {
        console.log('ä¸Šä¼ è¿›åº¦:', info)
      }
    })
    
    console.log('éƒ¨ç½²æˆåŠŸ!')
    await notification.notifyDeploySuccess(version, environment, commitHash)
    
    return result
  } catch (error) {
    console.error('éƒ¨ç½²å¤±è´¥:', error)
    await notification.notifyDeployFailure(version, environment, error.message)
    throw error
  }
}

deployWithNotification().catch(process.exit)
```

## æ€§èƒ½ç›‘æ§

### æ„å»ºæ—¶é—´ç›‘æ§

```javascript
// scripts/build-monitor.js
const fs = require('fs')
const path = require('path')

class BuildMonitor {
  constructor() {
    this.startTime = Date.now()
    this.stages = []
    this.metricsFile = './build-metrics.json'
  }
  
  // è®°å½•é˜¶æ®µå¼€å§‹
  startStage(name) {
    const stage = {
      name,
      startTime: Date.now(),
      endTime: null,
      duration: null
    }
    this.stages.push(stage)
    console.log(`[BUILD] å¼€å§‹é˜¶æ®µ: ${name}`)
    return stage
  }
  
  // è®°å½•é˜¶æ®µç»“æŸ
  endStage(stage) {
    stage.endTime = Date.now()
    stage.duration = stage.endTime - stage.startTime
    console.log(`[BUILD] å®Œæˆé˜¶æ®µ: ${stage.name} (${stage.duration}ms)`)
  }
  
  // ç”Ÿæˆæ„å»ºæŠ¥å‘Š
  generateReport() {
    const totalDuration = Date.now() - this.startTime
    const report = {
      timestamp: new Date().toISOString(),
      totalDuration,
      stages: this.stages,
      summary: {
        totalStages: this.stages.length,
        averageStageTime: this.stages.reduce((sum, stage) => sum + stage.duration, 0) / this.stages.length,
        slowestStage: this.stages.reduce((slowest, stage) => 
          stage.duration > slowest.duration ? stage : slowest
        )
      }
    }
    
    // ä¿å­˜åˆ°æ–‡ä»¶
    this.saveMetrics(report)
    
    // è¾“å‡ºæŠ¥å‘Š
    console.log('\n=== æ„å»ºæ€§èƒ½æŠ¥å‘Š ===')
    console.log(`æ€»è€—æ—¶: ${totalDuration}ms`)
    console.log(`æ€»é˜¶æ®µæ•°: ${report.summary.totalStages}`)
    console.log(`å¹³å‡é˜¶æ®µè€—æ—¶: ${Math.round(report.summary.averageStageTime)}ms`)
    console.log(`æœ€æ…¢é˜¶æ®µ: ${report.summary.slowestStage.name} (${report.summary.slowestStage.duration}ms)`)
    
    return report
  }
  
  // ä¿å­˜æ€§èƒ½æŒ‡æ ‡
  saveMetrics(report) {
    let metrics = []
    if (fs.existsSync(this.metricsFile)) {
      metrics = JSON.parse(fs.readFileSync(this.metricsFile, 'utf8'))
    }
    
    metrics.push(report)
    
    // åªä¿ç•™æœ€è¿‘ 100 æ¬¡æ„å»ºè®°å½•
    if (metrics.length > 100) {
      metrics = metrics.slice(-100)
    }
    
    fs.writeFileSync(this.metricsFile, JSON.stringify(metrics, null, 2))
  }
  
  // åˆ†ææ€§èƒ½è¶‹åŠ¿
  analyzeTrends() {
    if (!fs.existsSync(this.metricsFile)) {
      console.log('æ²¡æœ‰å†å²æ„å»ºæ•°æ®')
      return
    }
    
    const metrics = JSON.parse(fs.readFileSync(this.metricsFile, 'utf8'))
    if (metrics.length < 2) {
      console.log('æ„å»ºæ•°æ®ä¸è¶³ï¼Œæ— æ³•åˆ†æè¶‹åŠ¿')
      return
    }
    
    const recent = metrics.slice(-10) // æœ€è¿‘ 10 æ¬¡æ„å»º
    const avgDuration = recent.reduce((sum, m) => sum + m.totalDuration, 0) / recent.length
    const lastDuration = metrics[metrics.length - 1].totalDuration
    
    console.log('\n=== æ€§èƒ½è¶‹åŠ¿åˆ†æ ===')
    console.log(`æœ€è¿‘ 10 æ¬¡æ„å»ºå¹³å‡è€—æ—¶: ${Math.round(avgDuration)}ms`)
    console.log(`æœ¬æ¬¡æ„å»ºè€—æ—¶: ${lastDuration}ms`)
    
    if (lastDuration > avgDuration * 1.2) {
      console.log('âš ï¸  æœ¬æ¬¡æ„å»ºè€—æ—¶å¼‚å¸¸ï¼Œå»ºè®®æ£€æŸ¥æ„å»ºç¯å¢ƒ')
    } else if (lastDuration < avgDuration * 0.8) {
      console.log('âœ… æœ¬æ¬¡æ„å»ºæ€§èƒ½è‰¯å¥½')
    } else {
      console.log('â„¹ï¸  æœ¬æ¬¡æ„å»ºè€—æ—¶æ­£å¸¸')
    }
  }
}

module.exports = BuildMonitor
```

### åœ¨æ„å»ºè„šæœ¬ä¸­ä½¿ç”¨ç›‘æ§

```javascript
// scripts/monitored-build.js
const BuildMonitor = require('./build-monitor')
const { execSync } = require('child_process')

async function monitoredBuild() {
  const monitor = new BuildMonitor()
  
  try {
    // å®‰è£…ä¾èµ–
    let stage = monitor.startStage('å®‰è£…ä¾èµ–')
    execSync('npm ci', { stdio: 'inherit' })
    monitor.endStage(stage)
    
    // ä»£ç æ£€æŸ¥
    stage = monitor.startStage('ä»£ç æ£€æŸ¥')
    execSync('npm run lint', { stdio: 'inherit' })
    monitor.endStage(stage)
    
    // ç±»å‹æ£€æŸ¥
    stage = monitor.startStage('ç±»å‹æ£€æŸ¥')
    execSync('npm run type-check', { stdio: 'inherit' })
    monitor.endStage(stage)
    
    // å•å…ƒæµ‹è¯•
    stage = monitor.startStage('å•å…ƒæµ‹è¯•')
    execSync('npm run test', { stdio: 'inherit' })
    monitor.endStage(stage)
    
    // æ„å»ºé¡¹ç›®
    stage = monitor.startStage('æ„å»ºé¡¹ç›®')
    execSync('npm run build', { stdio: 'inherit' })
    monitor.endStage(stage)
    
    // ç”ŸæˆæŠ¥å‘Š
    const report = monitor.generateReport()
    monitor.analyzeTrends()
    
    return report
  } catch (error) {
    console.error('æ„å»ºå¤±è´¥:', error.message)
    monitor.generateReport()
    throw error
  }
}

if (require.main === module) {
  monitoredBuild().catch(process.exit)
}
```

## å®‰å…¨æœ€ä½³å®è·µ

### å¯†é’¥ç®¡ç†

```javascript
// scripts/key-manager.js
const crypto = require('crypto')
const fs = require('fs')

class KeyManager {
  constructor() {
    this.algorithm = 'aes-256-gcm'
  }
  
  // åŠ å¯†å¯†é’¥æ–‡ä»¶
  encryptKey(keyPath, password) {
    const keyContent = fs.readFileSync(keyPath)
    const iv = crypto.randomBytes(16)
    const cipher = crypto.createCipher(this.algorithm, password)
    
    let encrypted = cipher.update(keyContent)
    encrypted = Buffer.concat([encrypted, cipher.final()])
    
    const authTag = cipher.getAuthTag()
    
    const result = {
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex'),
      encrypted: encrypted.toString('hex')
    }
    
    fs.writeFileSync(`${keyPath}.encrypted`, JSON.stringify(result))
    console.log('å¯†é’¥æ–‡ä»¶åŠ å¯†å®Œæˆ')
  }
  
  // è§£å¯†å¯†é’¥æ–‡ä»¶
  decryptKey(encryptedKeyPath, password, outputPath) {
    const encryptedData = JSON.parse(fs.readFileSync(encryptedKeyPath, 'utf8'))
    
    const decipher = crypto.createDecipher(this.algorithm, password)
    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'))
    
    let decrypted = decipher.update(Buffer.from(encryptedData.encrypted, 'hex'))
    decrypted = Buffer.concat([decrypted, decipher.final()])
    
    fs.writeFileSync(outputPath, decrypted)
    console.log('å¯†é’¥æ–‡ä»¶è§£å¯†å®Œæˆ')
  }
  
  // ä¸´æ—¶è§£å¯†å¯†é’¥ï¼ˆç”¨äº CI/CDï¼‰
  async withTempKey(encryptedKeyPath, password, callback) {
    const tempKeyPath = `/tmp/temp-key-${Date.now()}.key`
    
    try {
      this.decryptKey(encryptedKeyPath, password, tempKeyPath)
      await callback(tempKeyPath)
    } finally {
      // ç¡®ä¿æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if (fs.existsSync(tempKeyPath)) {
        fs.unlinkSync(tempKeyPath)
      }
    }
  }
}

module.exports = KeyManager
```

### å®‰å…¨çš„éƒ¨ç½²è„šæœ¬

```javascript
// scripts/secure-deploy.js
const ci = require('miniprogram-ci')
const KeyManager = require('./key-manager')

async function secureDeploy() {
  const keyManager = new KeyManager()
  const encryptedKeyPath = './keys/private.key.encrypted'
  const keyPassword = process.env.KEY_PASSWORD
  
  if (!keyPassword) {
    throw new Error('KEY_PASSWORD ç¯å¢ƒå˜é‡æœªè®¾ç½®')
  }
  
  await keyManager.withTempKey(encryptedKeyPath, keyPassword, async (tempKeyPath) => {
    const project = new ci.Project({
      appid: process.env.MINIPROGRAM_APPID,
      type: 'miniProgram',
      projectPath: path.resolve('./'),
      privateKeyPath: tempKeyPath,
      ignores: ['node_modules/**/*']
    })
    
    const result = await ci.upload({
      project,
      version: process.env.VERSION,
      desc: process.env.DESC,
      setting: {
        es6: true,
        es7: true,
        minify: true,
        codeProtect: true
      }
    })
    
    console.log('å®‰å…¨éƒ¨ç½²å®Œæˆ')
    return result
  })
}

secureDeploy().catch(console.error)
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. ä¸Šä¼ å¤±è´¥é—®é¢˜

```javascript
// scripts/troubleshoot.js
const ci = require('miniprogram-ci')

async function diagnoseUploadIssues() {
  console.log('å¼€å§‹è¯Šæ–­ä¸Šä¼ é—®é¢˜...')
  
  // æ£€æŸ¥ç½‘ç»œè¿æ¥
  try {
    const https = require('https')
    await new Promise((resolve, reject) => {
      const req = https.request('https://api.weixin.qq.com', { method: 'HEAD' }, resolve)
      req.on('error', reject)
      req.end()
    })
    console.log('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸')
  } catch (error) {
    console.log('âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸:', error.message)
  }
  
  // æ£€æŸ¥å¯†é’¥æ–‡ä»¶
  const keyPath = process.env.PRIVATE_KEY_PATH
  if (!keyPath || !require('fs').existsSync(keyPath)) {
    console.log('âŒ å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨')
  } else {
    console.log('âœ… å¯†é’¥æ–‡ä»¶å­˜åœ¨')
  }
  
  // æ£€æŸ¥é¡¹ç›®é…ç½®
  try {
    const config = JSON.parse(require('fs').readFileSync('./project.config.json', 'utf8'))
    if (!config.appid) {
      console.log('âŒ project.config.json ä¸­ç¼ºå°‘ appid')
    } else {
      console.log('âœ… é¡¹ç›®é…ç½®æ­£å¸¸')
    }
  } catch (error) {
    console.log('âŒ é¡¹ç›®é…ç½®æ–‡ä»¶å¼‚å¸¸:', error.message)
  }
  
  // æ£€æŸ¥æ„å»ºäº§ç‰©
  if (!require('fs').existsSync('./dist')) {
    console.log('âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œæ„å»º')
  } else {
    console.log('âœ… æ„å»ºäº§ç‰©å­˜åœ¨')
  }
}

if (require.main === module) {
  diagnoseUploadIssues()
}
```

#### 2. è‡ªåŠ¨é‡è¯•æœºåˆ¶

```javascript
// scripts/retry-upload.js
const ci = require('miniprogram-ci')

async function uploadWithRetry(options, maxRetries = 3) {
  let lastError
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      console.log(`å°è¯•ä¸Šä¼  (${i + 1}/${maxRetries})...`)
      
      const result = await ci.upload(options)
      console.log('ä¸Šä¼ æˆåŠŸ!')
      return result
    } catch (error) {
      lastError = error
      console.log(`ä¸Šä¼ å¤±è´¥ (${i + 1}/${maxRetries}):`, error.message)
      
      if (i < maxRetries - 1) {
        const delay = Math.pow(2, i) * 1000 // æŒ‡æ•°é€€é¿
        console.log(`ç­‰å¾… ${delay}ms åé‡è¯•...`)
        await new Promise(resolve => setTimeout(resolve, delay))
      }
    }
  }
  
  throw new Error(`ä¸Šä¼ å¤±è´¥ï¼Œå·²é‡è¯• ${maxRetries} æ¬¡ã€‚æœ€åé”™è¯¯: ${lastError.message}`)
}

module.exports = { uploadWithRetry }
```

## æœ€ä½³å®è·µæ€»ç»“

### 1. åˆ†æ”¯ç­–ç•¥

```
main (ç”Ÿäº§ç¯å¢ƒ)
â”œâ”€â”€ develop (å¼€å‘ç¯å¢ƒ)
â”œâ”€â”€ feature/* (åŠŸèƒ½åˆ†æ”¯)
â”œâ”€â”€ hotfix/* (çƒ­ä¿®å¤åˆ†æ”¯)
â””â”€â”€ release/* (å‘å¸ƒåˆ†æ”¯)
```

### 2. ç‰ˆæœ¬å‘½åè§„èŒƒ

```
ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·[-é¢„å‘å¸ƒç‰ˆæœ¬å·]

ç¤ºä¾‹:
- 1.0.0 (æ­£å¼ç‰ˆæœ¬)
- 1.1.0-beta.1 (æµ‹è¯•ç‰ˆæœ¬)
- 1.0.1-hotfix.1 (çƒ­ä¿®å¤ç‰ˆæœ¬)
```

### 3. æäº¤ä¿¡æ¯è§„èŒƒ

```
<type>(<scope>): <subject>

type: feat, fix, docs, style, refactor, test, chore
scope: å½±å“èŒƒå›´
subject: ç®€çŸ­æè¿°

ç¤ºä¾‹:
feat(auth): æ·»åŠ å¾®ä¿¡ç™»å½•åŠŸèƒ½
fix(api): ä¿®å¤ç”¨æˆ·ä¿¡æ¯è·å–å¼‚å¸¸
docs(readme): æ›´æ–°éƒ¨ç½²æ–‡æ¡£
```

### 4. ç¯å¢ƒå˜é‡ç®¡ç†

```bash
# å¼€å‘ç¯å¢ƒ
NODE_ENV=development
MINIPROGRAM_APPID=dev-appid
API_BASE_URL=https://dev-api.example.com

# ç”Ÿäº§ç¯å¢ƒ
NODE_ENV=production
MINIPROGRAM_APPID=prod-appid
API_BASE_URL=https://api.example.com
```

### 5. ä»£ç è´¨é‡æ£€æŸ¥

```json
{
  "scripts": {
    "lint": "eslint src --ext .js,.ts,.vue",
    "lint:fix": "eslint src --ext .js,.ts,.vue --fix",
    "type-check": "tsc --noEmit",
    "test": "jest",
    "test:coverage": "jest --coverage"
  }
}
```

## æ‰©å±•èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [miniprogram-ci å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html)
- [å¾®ä¿¡å¼€å‘è€…å·¥å…·](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- [å°ç¨‹åºå‘å¸ƒæµç¨‹](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/release.html)

### å·¥å…·æ¨è
- **GitHub Actions**: å…è´¹çš„ CI/CD æœåŠ¡
- **GitLab CI/CD**: åŠŸèƒ½å¼ºå¤§çš„ DevOps å¹³å°
- **Jenkins**: çµæ´»çš„è‡ªåŠ¨åŒ–æœåŠ¡å™¨
- **Docker**: å®¹å™¨åŒ–éƒ¨ç½²

### ç›‘æ§å·¥å…·
- **Sentry**: é”™è¯¯ç›‘æ§å’Œæ€§èƒ½ç›‘æ§
- **LogRocket**: ç”¨æˆ·è¡Œä¸ºå½•åˆ¶å’Œåˆ†æ
- **Fundebug**: å°ç¨‹åºé”™è¯¯ç›‘æ§

é€šè¿‡æœ¬æŒ‡å—ï¼Œä½ åº”è¯¥èƒ½å¤Ÿä¸ºå°ç¨‹åºé¡¹ç›®æ­å»ºå®Œæ•´çš„ CI/CD æµç¨‹ï¼Œå®ç°è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ï¼Œæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚
